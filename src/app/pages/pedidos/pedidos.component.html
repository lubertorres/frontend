<!-- FILTROS -->
<div class="bg-white p-4 shadow rounded mb-4 grid grid-cols-12 gap-4">

    <!-- Estado -->
    <div class="col-span-3">
        <label class="block text-sm font-semibold">Estado</label>
        <select [(ngModel)]="filtros.estado" class="w-full border p-2 rounded">
            <option value="">Todos</option>
            <option value="PENDIENTE">Pendiente</option>
            <option value="COMPLETADO">Completado</option>
            <option value="CANCELADO">Cancelado</option>
        </select>
    </div>

    <!-- Identificación -->
    <div class="col-span-3">
        <label class="block text-sm font-semibold">Identificación Cliente</label>
        <input type="text" [(ngModel)]="filtros.identificacionCliente" class="w-full border p-2 rounded"
            placeholder="Ej: 093..." />
    </div>

    <!-- Fecha desde -->
    <div class="col-span-3">
        <label class="block text-sm font-semibold">Fecha Desde</label>
        <input type="date" [(ngModel)]="filtros.fechaDesde" class="w-full border p-2 rounded" />
    </div>

    <!-- Fecha hasta -->
    <div class="col-span-3">
        <label class="block text-sm font-semibold">Fecha Hasta</label>
        <input type="date" [(ngModel)]="filtros.fechaHasta" class="w-full border p-2 rounded" />
    </div>

    <!-- Botones -->
    <div class="col-span-12 flex justify-end gap-2 mt-2">
        <button class="px-4 py-2 bg-gray-300 rounded" (click)="limpiarFiltros()">
            Limpiar
        </button>
        <button class="px-4 py-2 bg-blue-600 text-white rounded" (click)="buscarPedidos()">
            Buscar
        </button>
    </div>

</div>


<div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold">Pedidos</h2>

    <button type="button" (click)="abrirModal()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
        + Registrar Pedido
    </button>
</div>

<data-table [data]="pedidos" [columns]="columnas" [showEstadoButton]="true" (onEdit)="editarPedido($event)"
    (onDelete)="eliminarPedido($event)" (onEstado)="abrirModalEstado($event)">
</data-table>

<app-modal [visible]="mostrarModal" title="Pedido" (close)="cerrarModal()">

    <form *ngIf="!esSoloLectura" class="space-y-4" (ngSubmit)="guardarPedido()">

        <div>
            <label class="block mb-1 font-medium">Cliente</label>
            <input type="text" class="w-full border p-2 rounded" [(ngModel)]="nuevo.clienteIdentificacion"
                name="clienteIdentificacion" required>
        </div>

        <div>

            <div class="flex justify-between items-center mb-2">
                <h3 class="font-semibold">Detalles del Pedido</h3>

                <button type="button" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700"
                    (click)="agregarDetalle()">
                    + Agregar Detalle
                </button>
            </div>

            <div *ngFor="let d of nuevo.detalles; let i = index; trackBy: trackByIndex"
                class="grid grid-cols-12 gap-2 mb-2 items-center">

                <!-- PRODUCTO -->
                <select class="col-span-6 border p-2 rounded w-full" [(ngModel)]="d.productoID"
                    [ngModelOptions]="{standalone: true}" required>
                    <option value="">Seleccione un producto</option>
                    <option *ngFor="let p of productos" [value]="p.productoID">
                        {{ p.nombre }}
                    </option>
                </select>

                <input type="number" class="col-span-4 border p-2 rounded" min="1" [(ngModel)]="d.cantidad"
                    [ngModelOptions]="{standalone: true}" required>

                <button type="button" class="col-span-2 text-red-600" (click)="eliminarDetalle(i)">
                    ✕
                </button>
            </div>

        </div>


        <div class="flex justify-end space-x-2 mt-4">
            <button type="button" (click)="cerrarModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
                Cancelar
            </button>

            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                Guardar
            </button>
        </div>

    </form>

    <div *ngIf="esSoloLectura">
        <p><strong>Cliente:</strong>
            {{ nuevo.clienteNombres }} {{ nuevo.clienteApellidos }}
        </p>

        <table class="w-full text-sm border mt-2">
            <thead>
                <tr class="bg-gray-100">
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Subtotal</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let d of nuevo.detalles">
                    <td>{{ d.productoNombre }}</td>
                    <td>{{ d.cantidad }}</td>
                    <td>{{ d.precioUnitario | currency }}</td>
                    <td>{{ d.subtotal | currency }}</td>
                </tr>
            </tbody>
        </table>
    </div>

</app-modal>

<app-modal [visible]="mostrarModalEstado" title="Cambiar Estado" width="400px" (close)="mostrarModalEstado = false">

    <div class="space-y-4">

        <p class="font-medium">
            Pedido #{{ pedidoSeleccionado?.pedidoID }}
        </p>

        <label class="block text-sm font-semibold">Nuevo Estado</label>

        <select [(ngModel)]="estadoSeleccionado" class="w-full border p-2 rounded">
            <option value="PENDIENTE">Pendiente</option>
            <option value="COMPLETADO">Completado</option>
            <option value="CANCELADO">Cancelado</option>
        </select>

        <div class="flex justify-end mt-3">
            <button class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" (click)="guardarEstado()">
                Guardar
            </button>
        </div>

    </div>
</app-modal>